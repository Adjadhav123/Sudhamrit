<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment | GorakshaAI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  
  <!-- Custom Responsive CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}" />
  
  <style>
    body {
      background: linear-gradient(to right, #a8edea, #fed6e3);
      font-family: 'Poppins', sans-serif;
    }
    .card {
      border-radius: 20px;
      border: none;
    }
    h3 {
      color: #2e3a59;
      font-weight: 600;
    }
    .form-label {
      font-weight: 500;
    }
    #submitBtn {
      border-radius: 30px;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    .btn-option {
      width: 100%;
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    .btn-option:hover {
      background-color: #198754;
      color: #fff;
    }
    .summary-box {
      background-color: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }
    .summary-item:last-child {
      border-bottom: none;
    }
    #selectedLocation {
      background-color: #fff9f0;
      padding: 15px;
      border-radius: 10px;
      border-left: 4px solid #ffc107;
      display: none;
    }
  </style>
</head>
<body>

  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-7 col-md-9">
        <div class="card shadow p-4 bg-white">
          <h3 class="text-center mb-4">üõí Complete Your Payment</h3>

          <!-- üßæ Order Summary -->
          <div class="summary-box mb-4">
            <div class="summary-item">
              <span>Subtotal:</span> <strong>‚Çπ250.00</strong>
            </div>
            <div class="summary-item">
              <span>Delivery Fee:</span> <strong>‚Çπ20.00</strong>
            </div>
            <div class="summary-item">
              <span>Total Payable:</span> <strong class="text-success">‚Çπ270.00</strong>
            </div>
          </div>

          <form id="paymentForm" method="POST" action="/payment_success">

            <!-- üöö Location Selection -->
            <div class="mb-4">
              <label class="form-label d-block mb-2">Select Delivery Location</label>
              <div class="d-flex gap-3">
                <button type="button" id="useCurrentLocation" class="btn btn-outline-success btn-option">
                  üìç Use Current Location
                </button>
                <button type="button" id="enterAddress" class="btn btn-outline-primary btn-option">
                  üè† Enter Address Manually
                </button>
              </div>
            </div>

            <!-- üè† Address Box -->
            <div id="addressBox" class="mb-3" style="display:none;">
              <label class="form-label">Delivery Address</label>
              <textarea class="form-control" id="address" name="address" rows="2" placeholder="Enter your delivery address"></textarea>
            </div>

            <!-- üìç Selected Location Preview -->
            <div id="selectedLocation" class="mb-3">
              <h6 class="mb-2 text-secondary">üìç Selected Delivery Location:</h6>
              <p id="locationDetails" class="mb-0 small"></p>
            </div>

            <!-- üí≥ Payment Method -->
            <div class="mb-3">
              <label class="form-label">Select Payment Method</label>
              <select class="form-select" name="payment_method" id="payment_method" required>
                <option value="">-- Choose Payment Option --</option>
                <option value="Razorpay">üí≥ Razorpay (Online)</option>
                <option value="UPI">üì± UPI Payment</option>
                <option value="Credit/Debit Card">üí∞ Credit / Debit Card</option>
                <option value="NetBanking">üè¶ Net Banking</option>
                <option value="Cash on Delivery">üíµ Cash on Delivery</option>
              </select>
            </div>

            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">

            <div class="text-center mt-4">
              <button type="submit" id="submitBtn" class="btn btn-success px-5 py-2">
                Proceed to Pay ‚Çπ270.00
              </button>
              <p id="loadingMsg" class="text-muted mt-2" style="display:none;">Fetching your location...</p>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    const useCurrentLocationBtn = document.getElementById('useCurrentLocation');
    const enterAddressBtn = document.getElementById('enterAddress');
    const addressBox = document.getElementById('addressBox');
    const addressInput = document.getElementById('address');
    const selectedLocationDiv = document.getElementById('selectedLocation');
    const locationDetails = document.getElementById('locationDetails');
    const submitBtn = document.getElementById('submitBtn');
    const loadingMsg = document.getElementById('loadingMsg');
    let locationType = "";

    // üåç Use manual address
    enterAddressBtn.addEventListener('click', () => {
      addressBox.style.display = 'block';
      selectedLocationDiv.style.display = 'none';
      locationType = "manual";
    });

    // üìç Use current location and reverse geocode
    useCurrentLocationBtn.addEventListener('click', async () => {
      addressBox.style.display = 'none';
      locationType = "current";
      selectedLocationDiv.style.display = 'block';
      locationDetails.innerHTML = "Detecting your current location...";

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          try {
            // Use Nominatim (OpenStreetMap) for reverse geocoding - FREE alternative
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`);
            const data = await res.json();

            let formattedAddress = "Unknown location";
            if (data && data.display_name) {
              formattedAddress = data.display_name;
            }

            locationDetails.innerHTML = `
              <strong>Address:</strong> ${formattedAddress}<br>
              <small>Latitude: ${lat.toFixed(4)}, Longitude: ${lng.toFixed(4)}</small>
            `;

            // Save to hidden fields
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            // Also populate the address field in case it's needed
            addressInput.value = formattedAddress;
          } catch (error) {
            console.error('Geocoding error:', error);
            locationDetails.innerHTML = `
              <strong>Coordinates detected:</strong><br>
              <small>Latitude: ${lat.toFixed(4)}, Longitude: ${lng.toFixed(4)}</small><br>
              <small class="text-muted">Address lookup unavailable</small>
            `;
            
            // Still save coordinates
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
          }
        }, function(error) {
          console.error('Geolocation error:', error);
          locationDetails.innerHTML = "‚ö†Ô∏è Unable to fetch your location. Please allow location permission in your browser.";
        });
      } else {
        locationDetails.innerHTML = "‚ùå Geolocation not supported by this browser.";
      }
    });

    // üí≥ Handle form submission
    document.getElementById('paymentForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      if (!locationType) {
        alert("Please select a delivery location option first!");
        return;
      }

      submitBtn.innerHTML = '‚è≥ Processing...';
      submitBtn.disabled = true;
      loadingMsg.style.display = 'block';

      if (locationType === "manual") {
        const address = addressInput.value.trim();
        if (!address) {
          alert("Please enter your address.");
          submitBtn.innerHTML = 'Proceed to Pay ‚Çπ270.00';
          submitBtn.disabled = false;
          loadingMsg.style.display = 'none';
          return;
        }

        // Get lat/lng for entered address using Nominatim
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
          const data = await response.json();
          
          if (data && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lng = parseFloat(data[0].lon);
            
            locationDetails.innerHTML = `
              <strong>Address:</strong> ${address}<br>
              <small>Latitude: ${lat.toFixed(4)}, Longitude: ${lng.toFixed(4)}</small>
            `;
            selectedLocationDiv.style.display = 'block';
            
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            // If you have a backend endpoint, send the data there
            await sendLocationToBackend(lat, lng, address);
          } else {
            alert("‚ùå Unable to fetch coordinates for the entered address. Please try a more specific address.");
            submitBtn.innerHTML = 'Proceed to Pay ‚Çπ270.00';
            submitBtn.disabled = false;
            loadingMsg.style.display = 'none';
          }
        } catch (err) {
          console.error('Geocoding error:', err);
          alert("‚ö†Ô∏è Error getting coordinates from address.");
          submitBtn.innerHTML = 'Proceed to Pay ‚Çπ270.00';
          submitBtn.disabled = false;
          loadingMsg.style.display = 'none';
        }
      } else {
        // Current location already saved above
        document.getElementById('paymentForm').submit();
      }
    });

    // üì® Save location in backend
    async function sendLocationToBackend(latitude, longitude, address) {
      try {
        const res = await fetch('/save_location', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ latitude, longitude, address })
        });
        const result = await res.json();
        if (!res.ok) {
          alert(result.error || "Failed to save location");
          submitBtn.innerHTML = 'Proceed to Pay ‚Çπ270.00';
          submitBtn.disabled = false;
          loadingMsg.style.display = 'none';
          return;
        }
        document.getElementById('paymentForm').submit();
      } catch (err) {
        console.error('Backend error:', err);
        alert("‚ö†Ô∏è Error saving location.");
        submitBtn.innerHTML = 'Proceed to Pay ‚Çπ270.00';
        submitBtn.disabled = false;
        loadingMsg.style.display = 'none';
      }
    }
  </script>

</body>
</html>